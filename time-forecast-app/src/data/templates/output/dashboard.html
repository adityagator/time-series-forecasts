{% extends 'dashboard_base.html' %}

{% block content %}

<section class="summary_results" id="summary_results" name="summary_results">
  <h1>Summary</h1>
  {% if inputObj.cluster %}
  <div id="div-cluster">
    <canvas id="volume-chart"></canvas>
    <canvas id="int-chart"></canvas>
  </div>
  {% endif %}
</section>

<section class="forecast_results" id="forecast_results" name="forecast_results">
  <h1>Forecast Results</h1>
  <!-- <label for="ship_pt">Ship_pt</label> -->
  {% if inputObj.forecast %}
    <div id="div_forecast">
      <select id="key" name="key">
        {% for key in output_dict %}
              <option value={{ key }}>{{ key }}</option>
        {% endfor %}
      </select>
        <canvas id="forecast-chart"></canvas>
      </div>
  {% else %}
      <h1>No data to display</h1>
  {% endif %}
      
    
    
</section>




<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
  <script>
    
    var configVol = {
      type: 'pie',
      data: {
        datasets: [{
          // data: {{ data|safe }},
          backgroundColor: ['rgba(255, 255, 0, 0.5)', 'rgba(255, 165, 0, 0.5)', 'rgba(255, 0, 0, 0.5)'],
          data: {{ volume_cluster }},
          label: 'Volume'
        }],
        labels: ['low', 'medium', 'high']
      },
      options: {
        responsive: true,
        title: {
          display: true,
          text: "Volume Clusters"
        }
      }
    };

    var configInt = {
      type: 'pie',
      data: {
        datasets: [{
          // data: {{ data|safe }},
          backgroundColor: ['rgba(255, 255, 0, 0.5)', 'rgba(255, 165, 0, 0.5)', 'rgba(255, 0, 0, 0.5)'],
          data: {{ int_cluster }},
          label: 'Intermittency'
        }],
        labels: ['low', 'medium', 'high']
      },
      options: {
        responsive: true,
        title: {
          display: true,
          text: "Intermittency Clusters"
        }
      }
    };










///////////////////////////////////////////////////////////////////////////////
    var output_dict = {{ output_dict|safe }}
    var input_dict = {{ input_dict|safe }}
    console.log(input_dict)
    // console.log(output_dict)
    // var ship_pt = $("#ship_pt :selected").text();
    // var prod_h = $("#prod_h :selected").text(); 
    // var part_no = $("#part_no :selected").text();
    // var key = ship_pt.concat("^").concat(prod_h).concat("^").concat(part_no);
    // $("select#ship_pt").change(function(){
    //   ship_pt = $("#ship_pt :selected").text();
    //   key = ship_pt.concat("^").concat(prod_h).concat("^").concat(part_no);
    //   console.log(key)
    // });
    // $("select#prod_h").change(function(){
    //   prod_h = $("#prod_h :selected").text();
    //   key = ship_pt.concat("^").concat(prod_h).concat("^").concat(part_no);
    //   console.log(key)
    // });
    // $("select#part_no").change(function(){
    //   part_no = $("#part_no :selected").text();
    //   key = ship_pt.concat("^").concat(prod_h).concat("^").concat(part_no);
    //   console.log(key)
    // });

    var key = $("#key :selected").text();

    function appendZerostoOutputArr(inputLen, outputArr){
        var final_arr = [];
        var count = 0;
        var countMix = 0;
        for (i = 0; i < inputLen + outputArr.length; i++){
        if(i < inputLen && i < (inputLen - output_dict[key][4].length)){
          final_arr[i] = null;
        }
        else if(i < inputLen){
          final_arr[i] = output_dict[key][4][countMix];
          countMix++;
        }
        else{
          final_arr[i] = outputArr[count];
          count++;
        }
      }
      return final_arr;
      }

      var inputData = {
        label: 'Input Demand',
        data: input_dict[key],
        // order: 1
        // backgroundColor: 'rgba(0, 99, 132, 0.5)',
        // borderWidth: 0,
        // yAxisID: "y-axis-density"
      };

      var outputData = {
        label: 'Predicted Demand',
        data: appendZerostoOutputArr(input_dict[key].length, output_dict[key][3]),
        backgroundColor: 'rgba(255,0,0,0.5)',
        // pointRadius: 0,
        // order: 2
        // borderWidth: 0,
        // yAxisID: "y-axis-gravity"
      };

      var totalData = {
        labels: makeLabel(input_dict[key].length + output_dict[key][3].length),
        datasets: [inputData, outputData]
      };
      totalData_arr = input_dict[key].concat(output_dict[key][3]);

    $("select#key").change(function(){
      key = $("#key :selected").text();

      totalData_arr = input_dict[key].concat(output_dict[key][3]);

      var inputData = {
        label: 'Input Demand',
        data: input_dict[key],
        // order: 1
        // backgroundColor: 'rgba(0, 99, 132, 0.5)',
        // borderWidth: 0,
        // yAxisID: "y-axis-density"
      };

      var outputData = {
        label: 'Predicted Demand',
        data: appendZerostoOutputArr(input_dict[key].length, output_dict[key][3]),
        backgroundColor: 'rgba(255,0,0,0.5)',
        // pointRadius: 0,
        // order: 2
        // borderWidth: 0,
        // yAxisID: "y-axis-gravity"
      };

      var totalData = {
        labels: makeLabel(input_dict[key].length + output_dict[key][3].length),
        datasets: [inputData, outputData]
      };

    //   var config2 = {
    //   type: 'line',
    //   data: {
    //     datasets: [{
    //       // data: {{ data|safe }},
    //       // backgroundColor: 'white',
    //       data: output_dict[key][3],
    //       label: 'forecasted demand'
    //     }],
    //     labels: {{ labels|safe }}
    //   },
    //   options: {
    //     responsive: true,
    //     title: {
    //       display: true,
    //       text: key
    //       // position: bottom
    //     }
    //   }
    // };
    //   var config2 = {
    //   type: 'bar',
    //   data: {
    //     labels: makeLabel(input_dict[key].length + output_dict[key][3].length),
    //     datasets: [{
    //       // data: {{ data|safe }},
    //       backgroundColor: getBackgroundColor(input_dict[key].length, output_dict[key][3].length),
    //       data: totalData_arr,
    //       label: 'input + forecasted demand'
    //     }],
    //     // labels: {{ labels|safe }}
    //   },
    //   options: {
    //     responsive: true,
    //     title: {
    //       display: true,
    //       text: key
    //       // position: bottom
    //     }
    //   }
    // };
    var config2 = {
      type: 'line',
      data: totalData,
      options: {
        elements: { point: { hitRadius: 10, hoverRadius: 10 } },
        responsive: true,
        title: {
          display: true,
          text: "Algorithm: ".concat(output_dict[key][0]).concat("          ").concat("RMSE: ").concat(output_dict[key][1]).concat("          ").concat("MAPE: ").concat(output_dict[key][2])
      },
      legend: {
            display: true,
            position: 'bottom'
        }
    }
    };
    

      if(currentChart){currentChart.destroy();}
      var ctx2 = document.getElementById('forecast-chart').getContext('2d');
      window.myPie = new Chart(ctx2, config2);
      currentChart = window.myPie;
      // key = ship_pt.concat("^").concat(prod_h).concat("^").concat(part_no);
      console.log(key)
    });

    // $("button").click(function() { 
    //   var key = ship_pt.concat("^").concat(prod_h).concat("^").concat(part_no);
    //   console.log(key);
    //         });

    // var key = ship_pt.concat("^").concat(prod_h).concat("^").concat(part_no);
    // console.log(key)
    // var test2 = $("#prod_h :selected").val();
    
    // $(document).on('change', '.div-toggle', function() {
    //   var target = $(this).data('target');
    //   var show = $("option:selected", this).data('show');
    //   $(target).children().addClass('hide');
    //   $(show).removeClass('hide');
    //   var config = {
    //   type: 'line',
    //   data: {
    //     datasets: [{
    //       // data: {{ data|safe }},
    //       // backgroundColor: 'white',
    //       data: output_dict[this.classname][3],
    //       label: 'demand'
    //     }],
    //     labels: {{ labels|safe }}
    //   },
    //   options: {
    //     responsive: true
    //   }
    // };
    // window.onload = function() {
    //   var ctx = document.getElementById('forecast-chart').getContext('2d');
    //   window.myPie = new Chart(ctx, config);
    // };
    // });
    // $(document).ready(function(){
    //     $('.div-toggle').trigger('change');
    // });

    // console.log(this.className);
    // var pointBackgroundColors = []
    var config = {
      type: 'line',
      data: totalData,
      options: {
        elements: { point: { hitRadius: 10, hoverRadius: 10 } },
        responsive: true,
        title: {
          display: true,
          text: "Algorithm: ".concat(output_dict[key][0]).concat("          ").concat("RMSE: ").concat(output_dict[key][1]).
          concat("          ").concat("MAPE: ").concat(output_dict[key][2])
      },
      legend: {
            display: true,
            position: 'bottom'
        }
    }
    };
    // if(currentChart){
    // for(i = 0; i < currentChart.data.datasets[0].data.length; i++){
    //     if(i >2)
    //       pointBackgroundColors.push("green");
    //     else
    //     pointBackgroundColors.push("red");
    // }
    // currentChart.update();
    // }

    var currentChart;

    function updateChart() {
     if(currentChart){currentChart.destroy();}
   
     var determineChart = $("#chartType").val();

     var params = dataMap[determineChart]
     currentChart = new Chart(ctx)[params.method](params.data, {});
 }

    function makeLabel(num){
      var label = [];
      for (i = 1; i <= num; i++){
        label[i - 1] = "Month".concat(" ").concat(i.toString()); 
      }
      return label;
    }

    function getBackgroundColor(inputLen, outputLen){
      bgArr = [];
      for (i = 0; i < inputLen + outputLen; i++){
        if(i < inputLen){
          bgArr[i] = "rgba(0, 0, 0, 0.1)";
        }
        else{
          bgArr[i] = "red";
        }
      }
      return bgArr;
    }

    // window.onload = function() {
    //   var ctx = document.getElementById('forecast-chart').getContext('2d');
    //   window.myPie = new Chart(ctx, config);
    //   currentChart = window.myPie;
    // };
    window.onload = function() {  
      var ctx = document.getElementById('forecast-chart').getContext('2d');
      window.myPie = new Chart(ctx, config);
      currentChart = window.myPie;
      var ctxVol = document.getElementById('volume-chart').getContext('2d');
      window.myBar = new Chart(ctxVol, configVol);
      var ctxInt = document.getElementById('int-chart').getContext('2d');
      window.myBar = new Chart(ctxInt, configInt);
    };

   </script>

{% endblock %}